---
import { Page } from "@components/Page"
import { PageHeader } from "@components/PageHeader.tsx"
import SiteLayout from "@layouts/SiteLayout.astro"
import TagFilterSearchBar from "@components/TagFilterSearchBar.astro"
import PaginationArrows from "@components/PaginationArrows.astro"
import { getCollection } from "astro:content"
import { BLOG_CATEGORIES } from "../../content/blogCategories"

const posts = (await getCollection("blog")).sort(
  (postA, postB) => +postB.data.publishDate - +postA.data.publishDate,
)
const tagCounts = BLOG_CATEGORIES.reduce(
  (acc, tag) => {
    acc[tag] = 0
    return acc
  },
  {} as Record<string, number>,
)

posts.forEach((post) => {
  const categories = post.data.categories ?? ["Reflection"]
  categories.forEach((category) => {
    tagCounts[category] = (tagCounts[category] ?? 0) + 1
  })
})

tagCounts.All = posts.length

const tagList = ["All", ...BLOG_CATEGORIES]
const formatter = new Intl.DateTimeFormat("en", {
  day: "2-digit",
  month: "2-digit",
  year: "numeric",
  timeZone: "UTC",
})
---

<SiteLayout title="Blog">
  <PageHeader>Posts</PageHeader>
  <Page>
    <TagFilterSearchBar
      tags={tagList}
      tagCounts={tagCounts}
      selectedTag="All"
      query=""
      debounceMs={250}
      matchMode="title_summary"
      targetSelector="#post-grid [data-post-card]"
    />
    <div id="post-grid" class="grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-3" tabindex="-1">
      {
        posts.map((post) => {
          const categories = post.data.categories ?? ["Reflection"]
          const searchText = `${post.data.title} ${post.data.description ?? ""}`.trim()

          return (
            <a
              href={`/blog/${post.slug}/`}
              class="group flex flex-col overflow-hidden rounded-lg bg-white transition duration-300 hover:-translate-y-1 hover:shadow-lg dark:bg-zinc-800 dark:text-zinc-100 dark:shadow-[0_7px_14px_#EAEAEA] shadow-[0_7px_14px_#0F0F0F]"
              data-post-card
              data-tags={categories.join("|")}
              data-search={searchText.toLowerCase()}
            >
              {/* Featured Image */}
              {post.data.image ? (
                <img src={post.data.image} alt={post.data.title} class="h-48 w-full object-cover" />
              ) : (
                <div class="h-48 w-full bg-gradient-to-br from-blue-200 to-blue-600 dark:from-slate-700 dark:to-slate-900" />
              )}

              {/* Content */}
              <div class="flex flex-1 flex-col p-6">
                {/* Category Badges */}
                <div class="mb-3 flex flex-wrap gap-2">
                  {categories.map((cat: string) => (
                    <span class="inline-block rounded-full bg-green-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-green-700 dark:bg-emerald-900/40 dark:text-emerald-200">
                      {cat}
                    </span>
                  ))}
                </div>

                {/* Title */}
                <h2 class="mb-3 text-xl font-bold leading-tight text-gray-900 transition-colors duration-200 group-hover:text-green-600 dark:text-zinc-100 dark:group-hover:text-green-400">
                  {post.data.title}
                </h2>

                {/* Description */}
                {post.data.description && (
                  <p class="mb-4 flex-1 text-sm leading-relaxed text-gray-600 dark:text-zinc-100">
                    {post.data.description}
                  </p>
                )}

                {/* Date */}
                <time class="text-xs font-medium uppercase tracking-wide text-gray-400 dark:text-zinc-100">
                  {formatter.format(post.data.publishDate)}
                </time>
              </div>
            </a>
          )
        })
      }
    </div>
    <PaginationArrows
      targetSelector="#post-grid [data-post-card]"
      focusTargetSelector="#post-grid"
      pageSize={9}
      compact={false}
    />
  </Page>
</SiteLayout>
