---
import AdminLayout from "@layouts/AdminLayout.astro"
import { eq } from "drizzle-orm"
import { BLOG_CATEGORIES } from "../../../../content/blogCategories"
import { db } from "../../../../database/drizzle"
import { blogsTable } from "../../../../database/schema"

export const prerender = false

const { slug } = Astro.params

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData()
  const id = String(formData.get("id") ?? "")
  const title = String(formData.get("title") ?? "").trim()
  const author = String(formData.get("author") ?? "").trim()
  const categoriesInput = formData.getAll("categories")
  const description = String(formData.get("description") ?? "").trim()
  const image = String(formData.get("image") ?? "").trim()
  const publishDateInput = String(formData.get("publishDate") ?? "")
  const statusInput = String(formData.get("status") ?? "Published").trim()
  const updatedSlug = String(formData.get("slug") ?? "").trim()
  const content = String(formData.get("content") ?? "").trim()

  const categories = categoriesInput
    .map((value) => String(value).trim())
    .filter(Boolean)
  const publishDateValue = new Date(publishDateInput)
  const isPublishDateValid = !Number.isNaN(publishDateValue.getTime())
  const isDraft = statusInput === "Draft"
  const now = new Date()
  let publishDate = isPublishDateValid ? publishDateValue : null

  if (isDraft) {
    if (!publishDate || publishDate <= now) {
      publishDate = new Date(now.getTime() + 86_400_000)
    }
  } else if (!publishDate || publishDate > now) {
    publishDate = now
  }

  if (id && title && updatedSlug && !Number.isNaN(publishDate.getTime()) && content) {
    await db
      .update(blogsTable)
      .set({
        title,
        author: author || "Maverick Espinosa",
        categories: categories.length ? categories : ["Reflection"],
        description: description || null,
        image: image || null,
        publishDate,
        slug: updatedSlug,
        content,
      })
      .where(eq(blogsTable.id, id))
  }

  return Astro.redirect("/admin/blogposts/")
}

const [post] = await db.select().from(blogsTable).where(eq(blogsTable.slug, slug ?? ""))
if (!post) {
  return Astro.redirect("/admin/blogposts/")
}

const publishDateValue =
  post.publishDate instanceof Date ? post.publishDate : new Date(post.publishDate)
const publishDateInput = Number.isNaN(publishDateValue.getTime())
  ? ""
  : publishDateValue.toISOString().slice(0, 10)
const selectedCategories = new Set(post.categories ?? ["Reflection"])
const statusValue = publishDateValue > new Date() ? "Draft" : "Published"
---

<AdminLayout title={`Edit ${post.title}`}>
  <div class="space-y-6">
    <div class="flex flex-wrap items-center gap-4">
      <a
        href="/admin/blogposts/"
        class="inline-flex items-center gap-2 rounded-2xl border border-zinc-200 bg-white px-4 py-2 text-sm font-semibold text-zinc-600 shadow-sm transition hover:border-zinc-300 hover:text-zinc-900"
      >
        <svg viewBox="0 0 24 24" class="h-4 w-4" fill="none" stroke="currentColor">
          <path d="M15 18l-6-6 6-6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        Go back
      </a>
      <div>
        <p class="text-xs uppercase tracking-[0.35em] text-zinc-500">Dashboard (Edit Blog)</p>
        <h1 class="mt-1 text-3xl font-semibold tracking-tight text-zinc-900">Edit {post.title}</h1>
      </div>
    </div>

    <form method="post" class="rounded-3xl border border-zinc-200 bg-white p-6 shadow-[0_30px_80px_-60px_rgba(15,23,42,0.2)]">
      <input type="hidden" name="id" value={post.id} />

      <div class="grid gap-5">
        <label class="grid gap-2 text-sm font-semibold text-zinc-700">
          Blog Title
          <input
            name="title"
            required
            value={post.title}
            class="rounded-2xl border border-zinc-200 bg-zinc-50 px-4 py-3 text-sm text-zinc-800 shadow-sm focus:border-indigo-400 focus:outline-none"
          />
        </label>

        <label class="grid gap-2 text-sm font-semibold text-zinc-700">
          Author
          <input
            name="author"
            value={post.author ?? "Maverick Espinosa"}
            class="rounded-2xl border border-zinc-200 bg-zinc-50 px-4 py-3 text-sm text-zinc-800 shadow-sm focus:border-indigo-400 focus:outline-none"
          />
        </label>

        <label class="grid gap-2 text-sm font-semibold text-zinc-700">
          Tags
          <select
            name="categories"
            multiple
            size={Math.min(BLOG_CATEGORIES.length, 8)}
            class="rounded-2xl border border-zinc-200 bg-zinc-50 px-4 py-3 text-sm text-zinc-800 shadow-sm focus:border-indigo-400 focus:outline-none"
          >
            {BLOG_CATEGORIES.map((category) => (
              <option value={category} selected={selectedCategories.has(category)}>
                {category}
              </option>
            ))}
          </select>
          <span class="text-xs font-normal text-zinc-500">Hold ctrl/cmd to select multiple.</span>
        </label>

        <label class="grid gap-2 text-sm font-semibold text-zinc-700">
          Description
          <textarea
            name="description"
            rows={3}
            class="rounded-2xl border border-zinc-200 bg-zinc-50 px-4 py-3 text-sm text-zinc-800 shadow-sm focus:border-indigo-400 focus:outline-none"
          >
            {post.description ?? ""}
          </textarea>
        </label>

        <label class="grid gap-2 text-sm font-semibold text-zinc-700">
          Blog Image
          <input
            name="image"
            value={post.image ?? ""}
            placeholder="/assets/images/..."
            class="rounded-2xl border border-zinc-200 bg-zinc-50 px-4 py-3 text-sm text-zinc-800 shadow-sm focus:border-indigo-400 focus:outline-none"
          />
        </label>

        <label class="grid gap-2 text-sm font-semibold text-zinc-700">
          Publish Date
          <input
            type="date"
            name="publishDate"
            value={publishDateInput}
            class="rounded-2xl border border-zinc-200 bg-zinc-50 px-4 py-3 text-sm text-zinc-800 shadow-sm focus:border-indigo-400 focus:outline-none"
          />
        </label>

        <label class="grid gap-2 text-sm font-semibold text-zinc-700">
          Status
          <select
            name="status"
            class="rounded-2xl border border-zinc-200 bg-zinc-50 px-4 py-3 text-sm text-zinc-800 shadow-sm focus:border-indigo-400 focus:outline-none"
          >
            <option value="Draft" selected={statusValue === "Draft"}>Draft</option>
            <option value="Published" selected={statusValue === "Published"}>Publish</option>
          </select>
        </label>

        <label class="grid gap-2 text-sm font-semibold text-zinc-700">
          Slug
          <input
            name="slug"
            required
            value={post.slug}
            class="rounded-2xl border border-zinc-200 bg-zinc-50 px-4 py-3 text-sm text-zinc-800 shadow-sm focus:border-indigo-400 focus:outline-none"
          />
        </label>

        <div class="grid gap-2 text-sm font-semibold text-zinc-700">
          <div class="flex items-center justify-between">
            <span>Content</span>
            <span class="text-xs font-normal text-zinc-500">Markdown supported.</span>
          </div>
          <div class="grid gap-4 lg:grid-cols-2">
            <textarea
              name="content"
              rows={14}
              data-markdown-input
              class="rounded-2xl border border-zinc-200 bg-zinc-50 px-4 py-3 text-sm text-zinc-800 shadow-sm focus:border-indigo-400 focus:outline-none"
            >
              {post.content ?? ""}
            </textarea>
            <div class="overflow-hidden rounded-2xl border border-zinc-200 bg-white shadow-sm">
              <div class="border-b border-zinc-200 bg-zinc-50 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] text-zinc-500">
                Preview
              </div>
              <div
                data-markdown-preview
                class="prose prose-sm max-w-none px-5 py-4 text-zinc-700 prose-headings:text-zinc-900 prose-a:text-indigo-600 prose-img:rounded-xl"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6 flex items-center justify-end">
        <button
          type="submit"
          class="inline-flex items-center justify-center rounded-2xl bg-indigo-600 px-6 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-indigo-500"
        >
          Save Blog
        </button>
      </div>
    </form>
  </div>
</AdminLayout>

<script type="module">
  import { marked } from "https://cdn.jsdelivr.net/npm/marked@12.0.2/+esm"

  const textarea = document.querySelector("[data-markdown-input]")
  const preview = document.querySelector("[data-markdown-preview]")

  if (textarea && preview) {
    marked.setOptions({ gfm: true, breaks: true })

    const render = () => {
      const value = textarea.value.trim()
      preview.innerHTML = value
        ? marked.parse(value)
        : "<p class='text-zinc-400'>Start typing to preview your markdown.</p>"
    }

    render()
    textarea.addEventListener("input", render)
  }
</script>
