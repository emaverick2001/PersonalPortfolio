---
import SiteLayout from "@layouts/SiteLayout.astro"
import type { GetStaticPaths } from "astro"
import { createMarkdownProcessor } from "@astrojs/markdown-remark"
import { db } from "../../database/drizzle"
import { blogsTable } from "../../database/schema"

export const getStaticPaths = (async () => {
  const blogEntries = await db.select().from(blogsTable)
  return blogEntries.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }))
}) satisfies GetStaticPaths

export const prerender = true
const { post } = Astro.props
const markdown = await createMarkdownProcessor()
const { code } = await markdown.render(post.content)

const formatter = new Intl.DateTimeFormat("en", { dateStyle: "full", timeZone: "UTC" })
const publishDate = post.publishDate instanceof Date ? post.publishDate : new Date(post.publishDate)
---

<!-- TODO: it'd be cool to have some tagline or something to use as the meta description -->
<SiteLayout title={post.title} description={post.description ?? ""}>
  <h1 class="mb-2 font-sans text-3xl font-bold tracking-tight text-zinc-900 dark:text-zinc-100">
    {post.title}
  </h1>
  <p class="mb-2 tracking-tight text-zinc-600 dark:text-zinc-400">
    {formatter.format(publishDate)}
  </p>
  <div class="mb-6">
    {
      (post.categories || ["Reflection"]).map((cat: string) => (
        <span class="inline-block rounded-full bg-green-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-green-700 dark:bg-emerald-900/40 dark:text-emerald-200">
          {cat}
        </span>
      ))
    }
  </div>
  {post.image && (
    <img src={post.image} alt={post.title} class="mx-auto mb-6 w-full max-w-2xl rounded-xl" />
  )}

  <article
    class="prose prose-zinc max-w-none dark:prose-invert lg:prose-lg prose-headings:font-sans prose-code:before:hidden prose-code:after:hidden"
    set:html={code}
  >
  </article>
</SiteLayout>
