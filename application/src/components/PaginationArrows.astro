---
interface Props {
  page?: number
  pageSize?: number
  disabled?: boolean
  compact?: boolean
  ariaLabel?: string
  targetSelector: string
  focusTargetSelector?: string
}

const {
  page = 1,
  pageSize = 9,
  disabled = false,
  compact = true,
  ariaLabel = "Pagination",
  targetSelector,
  focusTargetSelector,
} = Astro.props
---

<nav
  class="mt-8 flex items-center justify-between gap-3 text-sm text-gray-600 dark:text-zinc-300"
  aria-label={ariaLabel}
  data-pagination-root
  data-page-size={pageSize}
  data-initial-page={page}
  data-disabled={disabled}
  data-compact={compact}
  data-target-selector={targetSelector}
  data-focus-target={focusTargetSelector ?? targetSelector}
>
  <button
    type="button"
    class="inline-flex items-center gap-2 rounded-full border border-gray-200 px-4 py-2 font-semibold text-gray-700 transition hover:border-gray-300 hover:text-gray-900 disabled:cursor-not-allowed disabled:opacity-60 dark:border-zinc-700 dark:text-zinc-200 dark:hover:border-zinc-500 dark:hover:text-white"
    data-pagination-prev
    aria-label="Previous page"
  >
    <svg aria-hidden="true" viewBox="0 0 20 20" class="h-4 w-4" fill="currentColor">
      <path
        fill-rule="evenodd"
        d="M12.78 15.78a.75.75 0 0 1-1.06 0l-5-5a.75.75 0 0 1 0-1.06l5-5a.75.75 0 1 1 1.06 1.06L8.56 10l4.22 4.22a.75.75 0 0 1 0 1.06Z"
        clip-rule="evenodd"></path>
    </svg>
    <span data-pagination-prev-label>Prev</span>
  </button>

  <span
    class="text-xs uppercase tracking-wide text-gray-400 dark:text-zinc-500"
    data-pagination-status
    aria-live="polite"
  >
    Page 1 of 1
  </span>

  <button
    type="button"
    class="inline-flex items-center gap-2 rounded-full border border-gray-200 px-4 py-2 font-semibold text-gray-700 transition hover:border-gray-300 hover:text-gray-900 disabled:cursor-not-allowed disabled:opacity-60 dark:border-zinc-700 dark:text-zinc-200 dark:hover:border-zinc-500 dark:hover:text-white"
    data-pagination-next
    aria-label="Next page"
  >
    <span data-pagination-next-label>Next</span>
    <svg aria-hidden="true" viewBox="0 0 20 20" class="h-4 w-4" fill="currentColor">
      <path
        fill-rule="evenodd"
        d="M7.22 4.22a.75.75 0 0 1 1.06 0l5 5a.75.75 0 0 1 0 1.06l-5 5a.75.75 0 0 1-1.06-1.06L11.44 10 7.22 5.28a.75.75 0 0 1 0-1.06Z"
        clip-rule="evenodd"></path>
    </svg>
  </button>
</nav>

<script type="module">
  const roots = document.querySelectorAll("[data-pagination-root]")

  const applyVisibility = (card) => {
    const isHidden = card.dataset.filterHidden === "true" || card.dataset.pageHidden === "true"
    card.classList.toggle("hidden", isHidden)
  }

  const updateUrlParams = (params) => {
    const url = new URL(window.location.href)
    Object.entries(params).forEach(([key, value]) => {
      if (!value) {
        url.searchParams.delete(key)
        return
      }
      url.searchParams.set(key, value)
    })
    window.history.replaceState({}, "", url)
  }

  roots.forEach((root) => {
    const pageSize = Number(root.dataset.pageSize ?? "9")
    const compact = root.dataset.compact === "true"
    const isDisabled = root.dataset.disabled === "true"
    const targetSelector = root.dataset.targetSelector ?? ""
    const focusTargetSelector = root.dataset.focusTarget ?? targetSelector
    const allCards = Array.from(document.querySelectorAll(targetSelector))

    const prevButton = root.querySelector("[data-pagination-prev]")
    const nextButton = root.querySelector("[data-pagination-next]")
    const prevLabel = root.querySelector("[data-pagination-prev-label]")
    const nextLabel = root.querySelector("[data-pagination-next-label]")
    const status = root.querySelector("[data-pagination-status]")

    const urlParams = new URLSearchParams(window.location.search)
    const urlPage = Number(urlParams.get("page") ?? root.dataset.initialPage ?? "1")
    let page = Number.isFinite(urlPage) && urlPage > 0 ? urlPage : 1

    const updateButtons = (totalPages) => {
      const prevDisabled = isDisabled || page <= 1
      const nextDisabled = isDisabled || page >= totalPages
      if (prevButton) prevButton.disabled = prevDisabled
      if (nextButton) nextButton.disabled = nextDisabled
    }

    const updateStatus = (totalItems, totalPages, startIndex, endIndex) => {
      if (!status) return
      status.textContent = `Page ${page} of ${totalPages}`
      status.setAttribute("data-range", totalItems === 0 ? "0-0" : `${startIndex + 1}-${endIndex}`)
    }

    const focusList = () => {
      if (!focusTargetSelector) return
      const target = document.querySelector(focusTargetSelector)
      if (target && "focus" in target) target.focus()
    }

    const paginate = (options = {}) => {
      const { resetPage = false, syncUrl = true } = options
      const filteredCards = allCards.filter((card) => card.dataset.filterHidden !== "true")
      const totalItems = filteredCards.length
      const totalPages = Math.max(1, Math.ceil(totalItems / pageSize))

      if (resetPage) page = 1
      page = Math.min(Math.max(page, 1), totalPages)

      const startIndex = (page - 1) * pageSize
      const endIndex = Math.min(startIndex + pageSize, totalItems)

      allCards.forEach((card) => {
        if (card.dataset.filterHidden === "true") {
          card.dataset.pageHidden = "false"
          applyVisibility(card)
        }
      })

      filteredCards.forEach((card, index) => {
        const isPageVisible = index >= startIndex && index < endIndex
        card.dataset.pageHidden = String(!isPageVisible)
        applyVisibility(card)
      })

      updateButtons(totalPages)
      updateStatus(totalItems, totalPages, startIndex, endIndex)
      if (compact) {
        if (prevLabel) prevLabel.textContent = ""
        if (nextLabel) nextLabel.textContent = ""
      }

      if (syncUrl) {
        updateUrlParams({ page: page === 1 ? "" : String(page) })
      }
    }

    prevButton?.addEventListener("click", () => {
      if (page <= 1 || isDisabled) return
      page -= 1
      paginate()
      focusList()
    })

    nextButton?.addEventListener("click", () => {
      const filteredCards = allCards.filter((card) => card.dataset.filterHidden !== "true")
      const totalPages = Math.max(1, Math.ceil(filteredCards.length / pageSize))
      if (page >= totalPages || isDisabled) return
      page += 1
      paginate()
      focusList()
    })

    document.addEventListener("tagfilter:updated", () => {
      paginate({ resetPage: true })
    })

    paginate({ syncUrl: true })
  })
</script>
